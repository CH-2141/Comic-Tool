<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>漫展战术终端 Final</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyan-primary': '#06b6d4',
                        'cyan-hover': '#0891b2',
                        'cyan-light': '#ecfeff',
                    },
                    boxShadow: {
                        'float': '0 10px 30px -10px rgba(6, 182, 212, 0.4)',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- 核心修复：锁死网页层级滚动 --- */
        html, body { 
            width: 100%;
            height: 100%;
            overflow: hidden; /* 禁止 html/body 产生滚动条 */
            margin: 0;
            padding: 0;
            overscroll-behavior: none; /* 禁止浏览器橡皮筋回弹 */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }

        /* 列表容器 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .aspect-card { aspect-ratio: 3/4; }
        
        .status-pending { border-left: 5px solid #94a3b8; }
        .status-bought { border-left: 5px solid #06b6d4; }
        .status-soldout { border-left: 5px solid #ef4444; opacity: 0.7; filter: grayscale(100%); }
        .status-visited { border-left: 5px solid #8b5cf6; }

        /* 动画配置 */
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.25s cubic-bezier(0.25, 1, 0.5, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translate3d(0, 100%, 0); }

        .menu-pop-enter-active, .menu-pop-leave-active { transition: opacity 0.2s, transform 0.2s; }
        .menu-pop-enter-from, .menu-pop-leave-to { opacity: 0; transform: translateY(10px); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .map-pin {
            position: absolute; transform: translate3d(-50%, -100%, 0);
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); 
            animation: bounce 0.6s infinite alternate;
            will-change: transform;
        }
        @keyframes bounce { from { transform: translate3d(-50%, -100%, 0); } to { transform: translate3d(-50%, -115%, 0); } }

        .dragging-mode { box-shadow: none !important; transition: none !important; }
    </style>
</head>
<body>

<div id="app" class="w-full h-[100dvh] flex flex-col bg-slate-50 overflow-hidden relative">

    <header class="bg-white/95 backdrop-blur-sm px-5 py-4 z-10 flex justify-center items-center sticky top-0 shrink-0 border-b border-gray-100 shadow-sm">
        <div class="font-bold text-lg text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-map-location-dot text-cyan-primary text-xl"></i>
            <span class="tracking-wide">漫展战术终端</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 hide-scrollbar pb-40 overscroll-contain"
          @touchstart="handleListTouchStart" 
          @touchend="handleListTouchEnd">
        
        <div class="flex gap-2 mb-5 overflow-x-auto pb-2 justify-start sm:justify-center">
            <button v-for="tab in filters" :key="tab.key" @click="currentFilter = tab.key"
                :class="currentFilter === tab.key ? 'bg-gray-800 text-white shadow-lg scale-105' : 'bg-white text-gray-500'"
                class="px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-300">
                {{ tab.label }}
            </button>
        </div>

        <div v-if="filteredBooths.length > 0" class="grid grid-cols-1 min-[380px]:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 items-start min-h-[50vh]">
            <div v-for="booth in filteredBooths" :key="booth.id" @click="viewBooth(booth)"
                class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-200 active:scale-95 cursor-pointer relative group border border-gray-50 flex flex-col will-change-transform">
                
                <div class="aspect-card bg-gray-100 relative overflow-hidden shrink-0">
                    <img :src="booth.cover || placeholderImg" class="w-full h-full object-cover">
                    <div v-if="booth.status === 'bought'" class="absolute top-2 right-2 bg-cyan-primary text-white text-xs px-2 py-1 rounded-md shadow-md font-bold">GET!</div>
                    <div v-if="booth.status === 'soldout'" class="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-bold tracking-[0.2em]">SOLD OUT</div>
                </div>

                <div class="p-3" :class="'status-' + booth.status">
                    <h3 class="font-bold text-gray-800 text-sm truncate">{{ booth.name }}</h3>
                    <p class="text-xs text-gray-400 mt-1 truncate">{{ booth.goods || '暂无商品描述...' }}</p>
                </div>
            </div>
        </div>
        
        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-300 mt-10">
            <i class="fa-solid fa-box-open text-6xl mb-4 text-gray-200"></i>
            <p class="text-sm mt-2">列表为空<br><span class="text-xs opacity-60">左右快速滑动切换</span></p>
        </div>
    </main>

    <transition name="fade">
        <div v-if="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-white/60 z-20"></div>
    </transition>

    <div class="fixed bottom-8 right-6 flex flex-col items-end gap-4 z-30">
        <div class="flex flex-col gap-3 items-end">
            <transition-group name="menu-pop">
                <template v-if="isMenuOpen">
                    <button key="import" @click="triggerImport(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">导入数据</span>
                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fa-solid fa-file-import"></i></div>
                    </button>
                    <button key="export" @click="exportData(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">分享备份</span>
                        <div class="w-8 h-8 rounded-full bg-cyan-50 text-cyan-primary flex items-center justify-center"><i class="fa-solid fa-share-nodes"></i></div>
                    </button>
                    <button key="map" @click="triggerMapUpload(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">{{ globalSettings.mapImage ? '更换地图' : '设置地图' }}</span>
                        <div class="w-8 h-8 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fa-regular fa-image"></i></div>
                    </button>
                </template>
            </transition-group>
        </div>

        <button @click="isMenuOpen = !isMenuOpen" class="w-12 h-12 rounded-full bg-white text-gray-600 shadow-md flex items-center justify-center text-lg active:scale-90 transition z-30 border border-gray-100">
            <i class="fa-solid" :class="isMenuOpen ? 'fa-xmark' : 'fa-bars'"></i>
        </button>

        <button @click="openAddModal" class="h-14 px-6 rounded-full bg-cyan-primary text-white shadow-float flex items-center gap-2 font-bold text-lg active:scale-95 transition z-30">
            <i class="fa-solid fa-plus"></i> 
            <span>记摊位</span>
        </button>
    </div>

    <transition name="slide-up">
        <div v-if="activeBooth" class="fixed inset-0 z-40 flex flex-col justify-end sm:justify-center sm:items-center">
            
            <div @click="closeDetail" class="absolute inset-0 bg-black/30 transition-opacity"></div>
            
            <div class="bg-white w-full h-[92vh] sm:h-[85vh] sm:w-[500px] sm:rounded-3xl rounded-t-3xl relative flex flex-col overflow-hidden z-50 will-change-transform shadow-2xl"
                 :class="{ 'dragging-mode': isDragging }"
                 :style="{ transform: `translate3d(0, ${dragOffset}px, 0)`, transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.19, 1, 0.22, 1)' }"
                 @touchstart="handleModalTouchStart" 
                 @touchmove="handleModalTouchMove" 
                 @touchend="handleModalTouchEnd">
                
                <div class="w-full pt-4 pb-2 bg-white flex justify-center shrink-0 cursor-grab active:cursor-grabbing">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
                </div>

                <div class="px-6 py-2 flex items-center justify-between bg-white shrink-0">
                    <h2 class="text-xl font-bold text-gray-800 truncate pr-4">{{ activeBooth.name }}</h2>
                    <div class="flex gap-2">
                         <button @click.stop="editBooth(activeBooth)" class="w-9 h-9 rounded-full bg-gray-50 text-gray-400 hover:text-cyan-primary flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                         <button @click.stop="closeDetail" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto hide-scrollbar bg-white" ref="modalContentRef">
                    <div class="m-5 rounded-2xl overflow-hidden bg-gray-50 relative group border border-gray-100">
                        <div v-if="!globalSettings.mapImage" class="h-40 flex flex-col gap-2 items-center justify-center text-gray-400 text-sm">
                            <i class="fa-regular fa-map text-2xl"></i>
                            <span>请先设置地图</span>
                        </div>
                        <div v-else class="relative w-full">
                            <img :src="globalSettings.mapImage" class="w-full h-auto block">
                            <div v-if="activeBooth.x !== null" class="map-pin text-cyan-primary text-4xl"
                                :style="{ left: activeBooth.x + '%', top: activeBooth.y + '%' }">
                                <i class="fa-solid fa-location-dot"></i>
                            </div>
                        </div>
                    </div>

                    <div class="px-6 pb-6">
                        <div class="text-gray-600 leading-7 bg-slate-50 p-4 rounded-2xl text-[15px] whitespace-pre-wrap border border-slate-100 min-h-[80px]">
                            {{ activeBooth.goods || '暂无详细描述...' }}
                        </div>
                        <div class="mt-4" v-if="activeBooth.cover">
                            <div class="w-24 h-24 rounded-2xl overflow-hidden border border-gray-100">
                                <img :src="activeBooth.cover" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-gray-50">
                    <div class="grid grid-cols-4 gap-3">
                        <button @click.stop="updateStatus('bought')" 
                            :class="activeBooth.status === 'bought' ? 'bg-cyan-primary text-white shadow-lg' : 'bg-cyan-50 text-cyan-600'"
                            class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200">
                            <i class="fa-solid fa-check-circle text-xl"></i>
                            <span class="text-xs font-bold">买到了</span>
                        </button>
                        <button @click.stop="updateStatus('soldout')" 
                            :class="activeBooth.status === 'soldout' ? 'bg-red-500 text-white shadow-lg' : 'bg-red-50 text-red-500'"
                            class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200">
                            <i class="fa-solid fa-ban text-xl"></i>
                            <span class="text-xs font-bold">售罄</span>
                        </button>
                        <button @click.stop="updateStatus('visited')" 
                             :class="activeBooth.status === 'visited' ? 'bg-purple-500 text-white shadow-lg' : 'bg-purple-50 text-purple-500'"
                             class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200">
                            <i class="fa-solid fa-eye text-xl"></i>
                            <span class="text-xs font-bold">看过了</span>
                        </button>
                        <button @click.stop="deleteCurrentBooth" class="flex flex-col items-center gap-1 py-2.5 rounded-2xl text-gray-400 hover:bg-gray-100 active:scale-95 transition border border-gray-100">
                            <i class="fa-solid fa-trash text-xl"></i>
                            <span class="text-xs font-bold">删除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isEditing" class="fixed inset-0 z-50 bg-white/40 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl border border-gray-100 flex flex-col max-h-[90vh] overflow-hidden animate-[pop_0.3s_ease-out]">
                <div class="px-5 py-4 border-b border-gray-50 font-bold text-center text-lg text-gray-800">
                    {{ form.id ? '编辑摊位' : '记录新摊位' }}
                </div>
                <div class="p-5 overflow-y-auto flex-1 hide-scrollbar">
                    <div @click="$refs.coverInput.click()" class="w-full aspect-video bg-slate-50 rounded-2xl mb-4 flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-200 hover:border-cyan-primary/50 transition relative overflow-hidden group">
                        <img v-if="form.cover" :src="form.cover" class="w-full h-full object-cover">
                        <div v-else class="text-gray-400 flex flex-col items-center gap-2">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center"><i class="fa-solid fa-camera text-cyan-primary"></i></div>
                            <span class="text-xs font-medium">封面图</span>
                        </div>
                    </div>
                    <input type="file" ref="coverInput" class="hidden" accept="image/*" @change="handleCoverUpload">
                    <div class="space-y-3">
                        <input v-model="form.name" type="text" placeholder="摊位号 / 名称 (例如 A-12)" class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-cyan-primary/20 outline-none text-gray-800 font-bold">
                        <textarea v-model="form.goods" placeholder="想买什么谷子？记下来..." rows="3" class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-cyan-primary/20 outline-none resize-none text-gray-800"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wider">Map Point</label>
                        <div v-if="!globalSettings.mapImage" class="p-4 bg-red-50 text-red-400 text-xs rounded-xl text-center">请先设置地图</div>
                        <div v-else class="relative w-full rounded-xl overflow-hidden border border-gray-200 shadow-sm" @click="setMapPoint">
                            <img :src="globalSettings.mapImage" class="w-full block">
                            <div v-if="form.x !== null" class="absolute w-5 h-5 bg-cyan-primary rounded-full border-[3px] border-white shadow-lg transform -translate-x-1/2 -translate-y-1/2"
                                :style="{ left: form.x + '%', top: form.y + '%' }"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 flex gap-3">
                    <button @click="isEditing = false" class="flex-1 py-3 rounded-xl text-gray-500 font-medium hover:bg-gray-200 transition">取消</button>
                    <button @click="saveForm" class="flex-1 py-3 bg-cyan-primary text-white rounded-xl font-bold shadow-lg shadow-cyan-primary/30 active:scale-95 transition">保存</button>
                </div>
            </div>
        </div>
    </transition>

    <input type="file" ref="mapInput" class="hidden" accept="image/*" @change="handleMapUpload">
    <input type="file" ref="importInput" class="hidden" accept=".json" @change="handleImport">

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    const DB_NAME = 'ComicConDB';
    const DB_VERSION = 1;
    
    const dbUtils = {
        db: null,
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('booths')) db.createObjectStore('booths', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                request.onerror = (e) => reject(e);
            });
        },
        async getAllBooths() {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readonly');
                const req = tx.objectStore('booths').getAll();
                req.onsuccess = () => resolve(req.result || []);
            });
        },
        async saveBooth(booth) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').put(JSON.parse(JSON.stringify(booth)));
                tx.oncomplete = () => resolve();
            });
        },
        async deleteBooth(id) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').delete(id);
                tx.oncomplete = () => resolve();
            });
        },
        async getSetting(key) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readonly');
                const req = tx.objectStore('settings').get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
            });
        },
        async saveSetting(key, value) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readwrite');
                tx.objectStore('settings').put({ key, value });
                tx.oncomplete = () => resolve();
            });
        }
    };

    createApp({
        setup() {
            const booths = ref([]);
            const activeBooth = ref(null);
            const isEditing = ref(false);
            const isMenuOpen = ref(false);
            const currentFilter = ref('all');
            const globalSettings = reactive({ mapImage: null });
            const placeholderImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f1f5f9'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' fill='%23cbd5e1' text-anchor='middle' dy='.3em'%3ENO IMG%3C/text%3E%3C/svg%3E";
            const form = reactive({ id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending' });
            
            const filtersList = ['all', 'pending', 'bought', 'soldout'];
            const filters = [
                { key: 'all', label: '全部' }, 
                { key: 'pending', label: '待逛' }, 
                { key: 'bought', label: '已买' }, 
                { key: 'soldout', label: '售罄' }
            ];
            
            const importInput = ref(null);
            const modalContentRef = ref(null);
            const dragOffset = ref(0);
            const isDragging = ref(false);
            const touchStartY = ref(0);
            
            let listStartX = 0;
            let listStartY = 0;

            const filteredBooths = computed(() => {
                if (currentFilter.value === 'all') return booths.value;
                return booths.value.filter(b => b.status === currentFilter.value);
            });

            onMounted(async () => {
                await dbUtils.init();
                booths.value = await dbUtils.getAllBooths();
                globalSettings.mapImage = await dbUtils.getSetting('mapImage');
            });

            // 彻底移除 JS 滚动锁，只检测横向滑动切换Tab
            const handleListTouchStart = (e) => {
                listStartX = e.touches[0].clientX;
                listStartY = e.touches[0].clientY;
            };
            
            const handleListTouchEnd = (e) => {
                const dx = e.changedTouches[0].clientX - listStartX;
                const dy = e.changedTouches[0].clientY - listStartY;
                
                // 只有当横向移动明显大于纵向移动（防斜滑）且距离够长时，才切换
                if (Math.abs(dx) > Math.abs(dy) * 1.5 && Math.abs(dx) > 60) {
                    const currentIndex = filtersList.indexOf(currentFilter.value);
                    if (dx > 0 && currentIndex > 0) currentFilter.value = filtersList[currentIndex - 1]; 
                    else if (dx < 0 && currentIndex < filtersList.length - 1) currentFilter.value = filtersList[currentIndex + 1]; 
                }
            };

            const handleModalTouchStart = (e) => {
                if (modalContentRef.value && modalContentRef.value.scrollTop > 0) return;
                isDragging.value = true;
                touchStartY.value = e.touches[0].clientY;
            };

            const handleModalTouchMove = (e) => {
                if (!isDragging.value) return;
                const currentY = e.touches[0].clientY;
                const delta = currentY - touchStartY.value;
                if (delta > 0) {
                    dragOffset.value = delta;
                    if(e.cancelable) e.preventDefault();
                }
            };

            const handleModalTouchEnd = (e) => {
                isDragging.value = false;
                if (dragOffset.value > 100) closeDetail();
                else dragOffset.value = 0;
            };

            // 增强版图片压缩: 800px + 0.6 质量
            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const maxSize = 800; // 更激进的压缩尺寸

                            if (width > height && width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const exportData = async () => {
                if (booths.value.length === 0 && !globalSettings.mapImage) return alert('还没有数据可以导出哦');
                const data = { version: 1.0, map: globalSettings.mapImage, list: booths.value };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `漫展数据_${new Date().toISOString().slice(5,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const triggerImport = () => importInput.value.click();
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!confirm(`确定要导入吗？\n包含 ${data.list ? data.list.length : 0} 个摊位。`)) return;
                        if (data.map) {
                            globalSettings.mapImage = data.map;
                            await dbUtils.saveSetting('mapImage', data.map);
                        }
                        if (data.list && Array.isArray(data.list)) {
                            for (const item of data.list) { await dbUtils.saveBooth(item); }
                            booths.value = await dbUtils.getAllBooths();
                        }
                        alert("导入成功！");
                    } catch (err) { alert("文件格式不对"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const triggerMapUpload = () => document.querySelector('input[type=file]').click();
            const handleMapUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await compressImage(file);
                globalSettings.mapImage = base64;
                await dbUtils.saveSetting('mapImage', base64);
            };
            const handleCoverUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                form.cover = await compressImage(file);
            };
            
            const openAddModal = () => { Object.assign(form, { id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending' }); isEditing.value = true; };
            const editBooth = (booth) => { Object.assign(form, JSON.parse(JSON.stringify(booth))); isEditing.value = true; activeBooth.value = null; };
            const setMapPoint = (e) => {
                const rect = e.target.getBoundingClientRect();
                form.x = ((e.clientX - rect.left) / rect.width) * 100;
                form.y = ((e.clientY - rect.top) / rect.height) * 100;
            };
            const saveForm = async () => {
                if (!form.name) return alert('请填写摊位名称');
                const newBooth = { ...form, id: form.id || Date.now() };
                const index = booths.value.findIndex(b => b.id === newBooth.id);
                if (index > -1) booths.value[index] = newBooth; else booths.value.unshift(newBooth);
                await dbUtils.saveBooth(newBooth);
                isEditing.value = false;
            };
            
            const viewBooth = (b) => {
                activeBooth.value = b;
                dragOffset.value = 0; 
            };
            const closeDetail = () => {
                activeBooth.value = null;
                dragOffset.value = 0; 
            };
            
            const updateStatus = async (status) => {
                if (!activeBooth.value) return;
                activeBooth.value.status = status;
                const index = booths.value.findIndex(b => b.id === activeBooth.value.id);
                if (index > -1) booths.value[index].status = status;
                await dbUtils.saveBooth(activeBooth.value);
                closeDetail();
            };
            const deleteCurrentBooth = async () => {
                if (!confirm('确定删除?')) return;
                await dbUtils.deleteBooth(activeBooth.value.id);
                booths.value = booths.value.filter(b => b.id !== activeBooth.value.id);
                closeDetail();
            };
            const getStatusText = (s) => ({ pending: '待逛', bought: '已买', soldout: '售罄', visited: '看过' }[s]);

            return {
                booths, activeBooth, isEditing, isMenuOpen, form, currentFilter, filters, filteredBooths, globalSettings, placeholderImg, importInput,
                modalContentRef, dragOffset, isDragging,
                handleModalTouchStart, handleModalTouchMove, handleModalTouchEnd, 
                handleListTouchStart, handleListTouchEnd, 
                triggerMapUpload, handleMapUpload, handleCoverUpload, openAddModal, editBooth, setMapPoint, saveForm,
                viewBooth, closeDetail, updateStatus, deleteCurrentBooth, getStatusText,
                exportData, triggerImport, handleImport
            };
        }
    }).mount('#app');
</script>
</body>
</html>
