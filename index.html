<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>漫展扫货战术终端 Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; }
        .aspect-card { aspect-ratio: 3/4; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .status-pending { border-left: 4px solid #9ca3af; }
        .status-bought { border-left: 4px solid #10b981; }
        .status-soldout { border-left: 4px solid #ef4444; opacity: 0.6; filter: grayscale(80%); }
        .status-visited { border-left: 4px solid #3b82f6; }

        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .map-pin {
            position: absolute;
            transform: translate(-50%, -100%);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, -110%); } }
    </style>
</head>
<body>

<div id="app" class="w-full h-screen flex flex-col bg-gray-50 overflow-hidden relative shadow-2xl">

    <header class="bg-white px-3 py-3 shadow-sm z-10 flex justify-between items-center sticky top-0 shrink-0">
        <div class="font-bold text-lg text-gray-800 flex items-center gap-2 shrink-0">
            <i class="fa-solid fa-map-location-dot text-pink-500 text-2xl"></i>
            <span class="hidden sm:inline">漫展战术终端</span>
        </div>

        <div class="flex items-center gap-2 relative">
            
            <button @click="openAddModal" class="bg-pink-500 text-white h-9 px-4 rounded-full text-sm font-bold shadow-md active:scale-95 transition flex items-center gap-1 whitespace-nowrap">
                <i class="fa-solid fa-plus"></i> 
                <span>记摊位</span>
            </button>

            <button @click="isMenuOpen = !isMenuOpen" class="w-9 h-9 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition active:scale-95">
                <i class="fa-solid fa-bars"></i>
            </button>

            <transition name="fade">
                <div v-if="isMenuOpen" class="absolute top-12 right-0 w-40 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 flex flex-col py-1">
                    <div class="fixed inset-0 z-[-1]" @click="isMenuOpen = false"></div>
                    
                    <button @click="triggerMapUpload; isMenuOpen=false" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition text-left">
                        <i class="fa-regular fa-image w-4 text-center"></i>
                        <span>{{ globalSettings.mapImage ? '更换地图' : '设置地图' }}</span>
                    </button>
                    
                    <div class="h-[1px] bg-gray-100 mx-2"></div>

                    <button @click="exportData; isMenuOpen=false" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition text-left">
                        <i class="fa-solid fa-file-export w-4 text-center"></i>
                        <span>分享数据</span>
                    </button>

                    <button @click="triggerImport; isMenuOpen=false" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition text-left">
                        <i class="fa-solid fa-file-import w-4 text-center"></i>
                        <span>导入数据</span>
                    </button>
                </div>
            </transition>
        </div>

        <input type="file" ref="mapInput" class="hidden" accept="image/*" @change="handleMapUpload">
        <input type="file" ref="importInput" class="hidden" accept=".json" @change="handleImport">
    </header>

    <main class="flex-1 overflow-y-auto p-3 hide-scrollbar">
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
            <button v-for="tab in filters" :key="tab.key" 
                @click="currentFilter = tab.key"
                :class="currentFilter === tab.key ? 'bg-gray-800 text-white' : 'bg-white text-gray-500 border border-gray-200'"
                class="px-3 py-1 rounded-full text-xs whitespace-nowrap transition-colors">
                {{ tab.label }}
            </button>
        </div>

        <div v-if="filteredBooths.length > 0" class="grid grid-cols-1 min-[380px]:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 pb-20">
            <div v-for="booth in filteredBooths" :key="booth.id" @click="viewBooth(booth)"
                class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition active:scale-95 cursor-pointer relative group border border-gray-100">
                
                <div class="aspect-card bg-gray-200 relative overflow-hidden">
                    <img :src="booth.cover || placeholderImg" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    <div v-if="booth.status === 'bought'" class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-0.5 rounded shadow">GET!</div>
                    <div v-if="booth.status === 'soldout'" class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold tracking-widest">售罄</div>
                </div>

                <div class="p-2.5" :class="'status-' + booth.status">
                    <h3 class="font-bold text-gray-800 text-sm truncate">{{ booth.name }}</h3>
                    <p class="text-xs text-gray-400 mt-1 truncate">{{ booth.goods || '暂无商品描述...' }}</p>
                </div>
            </div>
        </div>

        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-400">
            <i class="fa-solid fa-box-open text-4xl mb-3"></i>
            <p class="text-sm">暂无数据，点右上角导入或新建</p>
        </div>
    </main>

    <transition name="slide-up">
        <div v-if="activeBooth" class="fixed inset-0 z-20 flex justify-end md:justify-center md:items-center pointer-events-none">
            <div @click="closeDetail" class="absolute inset-0 bg-black/20 pointer-events-auto backdrop-blur-sm"></div>
            
            <div class="bg-white w-full h-full md:h-[90vh] md:w-[600px] md:rounded-2xl flex flex-col pointer-events-auto shadow-2xl relative overflow-hidden">
                <div class="px-4 py-3 flex items-center justify-between border-b bg-white z-10">
                    <button @click="closeDetail" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                        <i class="fa-solid fa-chevron-down text-gray-600"></i>
                    </button>
                    <div class="font-bold text-gray-800">{{ activeBooth.name }}</div>
                    <button @click="editBooth(activeBooth)" class="text-gray-400 text-sm hover:text-pink-500">编辑</button>
                </div>

                <div class="flex-1 overflow-y-auto hide-scrollbar">
                    <div class="relative bg-gray-100 w-full overflow-hidden group">
                        <div v-if="!globalSettings.mapImage" class="h-48 flex items-center justify-center text-gray-400 text-sm">
                            请先设置地图
                        </div>
                        <div v-else class="relative w-full">
                            <img :src="globalSettings.mapImage" class="w-full h-auto block opacity-90">
                            <div v-if="activeBooth.x !== null" class="map-pin text-pink-600 text-3xl"
                                :style="{ left: activeBooth.x + '%', top: activeBooth.y + '%' }">
                                <i class="fa-solid fa-location-dot"></i>
                            </div>
                        </div>
                    </div>

                    <div class="p-5">
                        <h2 class="text-xl font-bold mb-2 flex items-center gap-2">
                            售卖情报
                            <span class="text-xs font-normal text-white px-2 py-0.5 rounded" 
                                  :class="getStatusColor(activeBooth.status)">
                                {{ getStatusText(activeBooth.status) }}
                            </span>
                        </h2>
                        <div class="text-gray-600 leading-relaxed whitespace-pre-wrap bg-gray-50 p-4 rounded-xl text-sm min-h-[100px]">
                            {{ activeBooth.goods || '暂无详细描述...' }}
                        </div>
                        
                        <div class="mt-6 flex gap-3 overflow-x-auto pb-2">
                            <div class="w-24 h-24 shrink-0 rounded-lg overflow-hidden bg-gray-200 border" v-if="activeBooth.cover">
                                <img :src="activeBooth.cover" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t bg-white grid grid-cols-4 gap-2">
                    <button @click="updateStatus('bought')" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-green-50 text-green-600">
                        <i class="fa-solid fa-check-circle text-xl"></i>
                        <span class="text-xs">已买到</span>
                    </button>
                    <button @click="updateStatus('soldout')" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-red-50 text-red-500">
                        <i class="fa-solid fa-ban text-xl"></i>
                        <span class="text-xs">售罄</span>
                    </button>
                    <button @click="updateStatus('visited')" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-blue-50 text-blue-500">
                        <i class="fa-solid fa-eye text-xl"></i>
                        <span class="text-xs">看过了</span>
                    </button>
                    <button @click="deleteCurrentBooth" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-gray-100 text-gray-400 border-l ml-2">
                        <i class="fa-solid fa-trash text-xl"></i>
                        <span class="text-xs">删除</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isEditing" class="absolute inset-0 z-30 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="px-4 py-3 border-b font-bold text-center relative">
                    {{ form.id ? '编辑摊位' : '新摊位' }}
                </div>
                
                <div class="p-4 overflow-y-auto flex-1">
                    <div @click="$refs.coverInput.click()" class="w-full aspect-video bg-gray-100 rounded-lg mb-4 flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-pink-400 relative overflow-hidden group">
                        <img v-if="form.cover" :src="form.cover" class="w-full h-full object-cover">
                        <div v-else class="text-gray-400 flex flex-col items-center">
                            <i class="fa-solid fa-camera text-2xl mb-1"></i>
                            <span class="text-xs">点击添加封面</span>
                        </div>
                    </div>
                    <input type="file" ref="coverInput" class="hidden" accept="image/*" @change="handleCoverUpload">

                    <input v-model="form.name" type="text" placeholder="摊位名称" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border-none focus:ring-2 focus:ring-pink-200 outline-none">
                    <textarea v-model="form.goods" placeholder="商品备注..." rows="3" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border-none focus:ring-2 focus:ring-pink-200 outline-none resize-none"></textarea>

                    <div class="mb-2">
                        <label class="text-xs text-gray-500 mb-1 block">点击地图标记位置:</label>
                        <div v-if="!globalSettings.mapImage" class="text-red-400 text-xs">请先在首页设置地图</div>
                        <div v-else class="relative w-full rounded-lg overflow-hidden border border-gray-200" @click="setMapPoint">
                            <img :src="globalSettings.mapImage" class="w-full block">
                            <div v-if="form.x !== null" class="absolute w-4 h-4 bg-pink-500 rounded-full border-2 border-white shadow transform -translate-x-1/2 -translate-y-1/2"
                                :style="{ left: form.x + '%', top: form.y + '%' }"></div>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t flex gap-3">
                    <button @click="isEditing = false" class="flex-1 py-2 rounded-lg text-gray-500 hover:bg-gray-100">取消</button>
                    <button @click="saveForm" class="flex-1 py-2 bg-pink-500 text-white rounded-lg font-bold shadow-md">保存</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive } = Vue;

    const DB_NAME = 'ComicConDB';
    const DB_VERSION = 1;
    
    const dbUtils = {
        db: null,
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('booths')) db.createObjectStore('booths', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                request.onerror = (e) => reject(e);
            });
        },
        async getAllBooths() {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readonly');
                const req = tx.objectStore('booths').getAll();
                req.onsuccess = () => resolve(req.result || []);
            });
        },
        async saveBooth(booth) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').put(JSON.parse(JSON.stringify(booth)));
                tx.oncomplete = () => resolve();
            });
        },
        async deleteBooth(id) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').delete(id);
                tx.oncomplete = () => resolve();
            });
        },
        async getSetting(key) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readonly');
                const req = tx.objectStore('settings').get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
            });
        },
        async saveSetting(key, value) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readwrite');
                tx.objectStore('settings').put({ key, value });
                tx.oncomplete = () => resolve();
            });
        }
    };

    createApp({
        setup() {
            const booths = ref([]);
            const activeBooth = ref(null);
            const isEditing = ref(false);
            const isMenuOpen = ref(false); // 新增：控制菜单显示
            const currentFilter = ref('all');
            const globalSettings = reactive({ mapImage: null });
            const placeholderImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f3f4f6'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' fill='%239ca3af' text-anchor='middle' dy='.3em'%3E无封面%3C/text%3E%3C/svg%3E";
            const form = reactive({ id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending' });
            const filters = [{ key: 'all', label: '全部' }, { key: 'pending', label: '待逛' }, { key: 'bought', label: '已买' }, { key: 'soldout', label: '售罄' }];
            const importInput = ref(null);

            const filteredBooths = computed(() => {
                if (currentFilter.value === 'all') return booths.value;
                return booths.value.filter(b => b.status === currentFilter.value);
            });

            onMounted(async () => {
                await dbUtils.init();
                booths.value = await dbUtils.getAllBooths();
                globalSettings.mapImage = await dbUtils.getSetting('mapImage');
            });

            // --- 导入导出功能 ---
            const exportData = async () => {
                if (booths.value.length === 0 && !globalSettings.mapImage) return alert('还没有数据可以导出哦');
                const data = { version: 1.0, map: globalSettings.mapImage, list: booths.value };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `漫展摊位数据_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const triggerImport = () => importInput.value.click();
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!confirm(`确定要导入吗？\n包含 ${data.list ? data.list.length : 0} 个摊位。`)) return;
                        if (data.map) {
                            globalSettings.mapImage = data.map;
                            await dbUtils.saveSetting('mapImage', data.map);
                        }
                        if (data.list && Array.isArray(data.list)) {
                            for (const item of data.list) { await dbUtils.saveBooth(item); }
                            booths.value = await dbUtils.getAllBooths();
                        }
                        alert("导入成功！");
                    } catch (err) { alert("文件格式不对"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            // --- 原有逻辑 ---
            const triggerMapUpload = () => document.querySelector('input[type=file]').click();
            const handleMapUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await fileToBase64(file);
                globalSettings.mapImage = base64;
                await dbUtils.saveSetting('mapImage', base64);
            };
            const handleCoverUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                form.cover = await fileToBase64(file);
            };
            const fileToBase64 = (file) => new Promise((r) => { const reader = new FileReader(); reader.onload = (e) => r(e.target.result); reader.readAsDataURL(file); });
            const openAddModal = () => { Object.assign(form, { id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending' }); isEditing.value = true; };
            const editBooth = (booth) => { Object.assign(form, JSON.parse(JSON.stringify(booth))); isEditing.value = true; activeBooth.value = null; };
            const setMapPoint = (e) => {
                const rect = e.target.getBoundingClientRect();
                form.x = ((e.clientX - rect.left) / rect.width) * 100;
                form.y = ((e.clientY - rect.top) / rect.height) * 100;
            };
            const saveForm = async () => {
                if (!form.name) return alert('请填写摊位名称');
                const newBooth = { ...form, id: form.id || Date.now() };
                const index = booths.value.findIndex(b => b.id === newBooth.id);
                if (index > -1) booths.value[index] = newBooth; else booths.value.unshift(newBooth);
                await dbUtils.saveBooth(newBooth);
                isEditing.value = false;
            };
            const viewBooth = (b) => activeBooth.value = b;
            const closeDetail = () => activeBooth.value = null;
            const updateStatus = async (status) => {
                if (!activeBooth.value) return;
                activeBooth.value.status = status;
                const index = booths.value.findIndex(b => b.id === activeBooth.value.id);
                if (index > -1) booths.value[index].status = status;
                await dbUtils.saveBooth(activeBooth.value);
                if (status === 'visited') closeDetail(); 
            };
            const deleteCurrentBooth = async () => {
                if (!confirm('确定删除?')) return;
                await dbUtils.deleteBooth(activeBooth.value.id);
                booths.value = booths.value.filter(b => b.id !== activeBooth.value.id);
                closeDetail();
            };
            const getStatusText = (s) => ({ pending: '待逛', bought: '已买到', soldout: '已售罄', visited: '已看过' }[s]);
            const getStatusColor = (s) => ({ pending: 'bg-gray-400', bought: 'bg-green-500', soldout: 'bg-red-500', visited: 'bg-blue-500' }[s]);

            return {
                booths, activeBooth, isEditing, isMenuOpen, form, currentFilter, filters, filteredBooths, globalSettings, placeholderImg, importInput,
                triggerMapUpload, handleMapUpload, handleCoverUpload, openAddModal, editBooth, setMapPoint, saveForm,
                viewBooth, closeDetail, updateStatus, deleteCurrentBooth, getStatusText, getStatusColor,
                exportData, triggerImport, handleImport
            };
        }
    }).mount('#app');
</script>
</body>
</html>
