<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>漫展战术终端</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyan-primary': '#06b6d4',
                        'cyan-hover': '#0891b2',
                        'cyan-light': '#ecfeff',
                        'star-gold': '#fbbf24',
                    },
                    boxShadow: {
                        'float': '0 8px 30px -6px rgba(0,0,0,0.15)',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        html, body {
            position: fixed; width: 100%; height: 100%; overflow: hidden;
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent; touch-action: pan-y;
        }
        .scroll-container { -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .aspect-card { aspect-ratio: 1/1; }
        
        .status-pending { border-left: 5px solid #94a3b8; }
        .status-bought { border-left: 5px solid #06b6d4; }
        .status-soldout { border-left: 5px solid #ef4444; opacity: 0.7; filter: grayscale(100%); }
        .status-visited { border-left: 5px solid #8b5cf6; }

        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1); will-change: transform; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translate3d(0, 100%, 0); }

        .menu-pop-enter-active, .menu-pop-leave-active { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .menu-pop-enter-from, .menu-pop-leave-to { opacity: 0; transform: translateY(10px) scale(0.95); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .map-pin {
            position: absolute; transform: translate3d(-50%, -100%, 0);
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); 
            animation: bounce 0.6s infinite alternate; will-change: transform;
        }
        @keyframes bounce { from { transform: translate3d(-50%, -100%, 0); } to { transform: translate3d(-50%, -115%, 0); } }
        
        .dragging-mode { box-shadow: none !important; transition: none !important; }
        .invisible-input { position: absolute; top: 0; left: 0; width: 0; height: 0; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="app" class="w-full h-[100dvh] flex flex-col bg-slate-50 relative">

    <header class="bg-white/95 backdrop-blur-sm px-5 py-3 z-10 flex justify-center items-center sticky top-0 shrink-0 border-b border-gray-100 shadow-sm">
        <div class="font-bold text-lg text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-map-location-dot text-cyan-primary text-xl"></i>
            <span class="tracking-wide">漫展战术终端</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 hide-scrollbar pb-40 scroll-container"
          @touchstart="handleListTouchStart" 
          @touchend="handleListTouchEnd">
        
        <div class="sticky top-0 z-10 -mx-4 px-4 pt-1 pb-3 bg-slate-50/95 backdrop-blur-sm space-y-3 mb-2">
            <div class="relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-cyan-primary transition"></i>
                <input v-model="searchQuery" type="text" placeholder="搜索摊位号、名称、谷子..." 
                    class="w-full bg-white h-10 pl-10 pr-4 rounded-xl border border-gray-200 text-sm focus:outline-none focus:border-cyan-primary focus:ring-1 focus:ring-cyan-primary transition shadow-sm">
                <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fa-solid fa-circle-xmark"></i></button>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                    <button v-for="tab in filters" :key="tab.key" @click="currentFilter = tab.key"
                        :class="currentFilter === tab.key ? 'bg-gray-800 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'"
                        class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all duration-300">
                        {{ tab.label }}
                    </button>
                </div>
                
                <button @click="cycleSort" class="flex items-center gap-1 text-xs font-bold px-3 py-1.5 rounded-full bg-white border border-gray-200 text-gray-600 active:scale-95 transition">
                    <i class="fa-solid" :class="sortIcon"></i>
                    <span>{{ sortLabel }}</span>
                </button>
            </div>
        </div>

        <div v-if="filteredBooths.length > 0" class="grid grid-cols-1 min-[380px]:grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 items-start min-h-[10px]">
            <div v-for="booth in filteredBooths" :key="booth.id" @click="viewBooth(booth)"
                class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-200 active:scale-95 cursor-pointer relative group border border-gray-50 flex flex-col will-change-transform">
                
                <div class="aspect-card bg-gray-100 relative overflow-hidden shrink-0">
                    <img :src="booth.cover || placeholderImg" class="w-full h-full object-contain bg-gray-100">
                    
                    <div v-if="booth.status === 'bought'" class="absolute top-2 right-2 bg-cyan-primary text-white text-[10px] px-2 py-1 rounded-md shadow-md font-bold">GET!</div>
                    <div v-if="booth.status === 'soldout'" class="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-bold tracking-[0.2em]">SOLD OUT</div>
                    
                    <div v-if="booth.rating > 0" class="absolute bottom-2 left-2 bg-black/60 text-star-gold backdrop-blur-md text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1">
                        <i class="fa-solid fa-star"></i> {{ booth.rating }}
                    </div>
                </div>

                <div class="p-3" :class="'status-' + booth.status">
                    <h3 class="font-bold text-gray-800 text-sm truncate">{{ booth.name }}</h3>
                    <p class="text-xs text-gray-400 mt-1 truncate">{{ booth.goods || '暂无商品描述...' }}</p>
                    <p class="text-[10px] text-gray-400 mt-1 flex items-center gap-1">
                        <i class="fa-solid fa-map-pin"></i> {{ getMapName(booth.mapId) }}
                    </p>
                </div>
            </div>
        </div>
        
        <div v-else class="flex flex-col items-center justify-center h-64 text-gray-300 mt-4">
            <i class="fa-solid fa-box-open text-5xl mb-3 text-gray-200"></i>
            <p class="text-sm">没有找到相关摊位</p>
        </div>
    </main>

    <transition name="fade">
        <div v-if="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-white/60 z-20"></div>
    </transition>

    <div class="fixed bottom-8 right-6 flex flex-col items-end gap-4 z-30">
        <div class="flex flex-col gap-3 items-end">
            <transition-group name="menu-pop">
                <template v-if="isMenuOpen">
                    <button key="import" @click="triggerImport(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">导入数据</span>
                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fa-solid fa-file-import"></i></div>
                    </button>
                    <button key="export" @click="exportData(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">分享备份</span>
                        <div class="w-8 h-8 rounded-full bg-cyan-50 text-cyan-primary flex items-center justify-center"><i class="fa-solid fa-share-nodes"></i></div>
                    </button>
                    <button key="map" @click="openMapManager(); isMenuOpen=false" class="flex items-center gap-3 bg-white text-gray-700 px-4 py-2.5 rounded-2xl shadow-float transition transform active:scale-95">
                        <span class="text-sm font-bold text-gray-600">地图管理</span>
                        <div class="w-8 h-8 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fa-regular fa-map"></i></div>
                    </button>
                </template>
            </transition-group>
        </div>

        <button @click="isMenuOpen = !isMenuOpen" class="w-12 h-12 rounded-full bg-white text-gray-600 shadow-md flex items-center justify-center text-lg active:scale-90 transition z-30 border border-gray-100">
            <i class="fa-solid" :class="isMenuOpen ? 'fa-xmark' : 'fa-bars'"></i>
        </button>

        <button @click="openAddModal" class="h-14 px-6 rounded-full bg-cyan-primary text-white shadow-float flex items-center gap-2 font-bold text-lg active:scale-95 transition z-30">
            <i class="fa-solid fa-plus"></i> 
            <span>记摊位</span>
        </button>
    </div>

    <transition name="slide-up">
        <div v-if="activeBooth" class="fixed inset-0 z-40 flex flex-col justify-end sm:justify-center sm:items-center">
            
            <div @click="closeDetail" class="absolute inset-0 bg-black/40 transition-opacity"></div>
            
            <div class="bg-white w-full h-[92vh] sm:h-[85vh] sm:w-[500px] sm:rounded-3xl rounded-t-3xl relative flex flex-col overflow-hidden z-50 shadow-2xl"
                 :class="{ 'dragging-mode': isDragging }"
                 :style="{ transform: `translate3d(0, ${dragOffset}px, 0)`, transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.2, 0.9, 0.2, 1)' }"
                 @touchstart="handleModalTouchStart" 
                 @touchmove="handleModalTouchMove" 
                 @touchend="handleModalTouchEnd">
                
                <div class="w-full pt-4 pb-2 bg-white flex justify-center shrink-0 cursor-grab active:cursor-grabbing">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
                </div>

                <div class="px-6 py-2 flex items-center justify-between bg-white shrink-0">
                    <div class="flex flex-col overflow-hidden pr-4">
                        <h2 class="text-xl font-bold text-gray-800 truncate">{{ activeBooth.name }}</h2>
                        <div class="flex items-center gap-1 mt-1">
                            <i v-for="n in 5" :key="n" class="fa-solid fa-star text-[10px]" :class="n <= (activeBooth.rating||3) ? 'text-star-gold' : 'text-gray-200'"></i>
                        </div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                         <button @click.stop="editBooth(activeBooth)" class="w-9 h-9 rounded-full bg-gray-50 text-gray-400 hover:text-cyan-primary flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                         <button @click.stop="closeDetail" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto hide-scrollbar bg-white" ref="modalContentRef">
                    
                    <div class="mx-5 mt-2 rounded-2xl overflow-hidden border border-gray-100 shadow-sm relative bg-gray-100">
                        <img v-if="activeBooth.cover" :src="activeBooth.cover" class="w-full h-auto block">
                        <div v-else class="flex flex-col items-center justify-center h-40 text-gray-300">
                            <i class="fa-solid fa-image text-3xl"></i>
                            <span class="text-xs mt-2">暂无封面</span>
                        </div>
                    </div>

                    <div class="px-6 py-4">
                        <div class="text-gray-600 leading-7 bg-slate-50 p-4 rounded-2xl text-[15px] whitespace-pre-wrap border border-slate-100 min-h-[80px]">
                            {{ activeBooth.goods || '暂无详细描述...' }}
                        </div>
                    </div>

                    <div class="mx-5 mb-6 rounded-2xl overflow-hidden border border-gray-200 shadow-inner h-[250px] relative bg-slate-100">
                        <div v-if="!getMapImage(activeBooth.mapId)" class="h-full flex flex-col gap-2 items-center justify-center text-gray-400 text-sm">
                            <i class="fa-regular fa-map text-2xl"></i>
                            <span>未设置对应地图</span>
                        </div>
                        <div v-else 
                             class="w-full h-full relative overflow-hidden touch-none"
                             ref="viewMapContainer"
                             @touchstart="mapHandlers.start" 
                             @touchmove="mapHandlers.move" 
                             @touchend="mapHandlers.end">
                            
                            <div :style="mapStyle" class="origin-top-left">
                                <img :src="getMapImage(activeBooth.mapId)" class="block w-full h-auto pointer-events-none select-none">
                                <div v-if="activeBooth.x !== null" class="map-pin text-cyan-primary text-4xl"
                                    :style="{ left: activeBooth.x + '%', top: activeBooth.y + '%', transform: `translate(-50%, -100%) scale(${1/mapTransform.scale})` }">
                                    <i class="fa-solid fa-location-dot"></i>
                                </div>
                            </div>
                            
                            <div class="absolute bottom-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md pointer-events-none">
                                双指缩放 / 单指移动
                            </div>
                        </div>
                        <div class="absolute top-2 left-2 bg-cyan-primary/90 text-white text-xs px-2 py-1 rounded shadow-sm">
                            <i class="fa-solid fa-map-pin mr-1"></i> {{ getMapName(activeBooth.mapId) }}
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-gray-50">
                    <div class="grid grid-cols-4 gap-3">
                        <button @click.stop="updateStatus('bought')" class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200" :class="activeBooth.status === 'bought' ? 'bg-cyan-primary text-white shadow-lg' : 'bg-cyan-50 text-cyan-600'"><i class="fa-solid fa-check-circle text-xl"></i><span class="text-xs font-bold">买到了</span></button>
                        <button @click.stop="updateStatus('soldout')" class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200" :class="activeBooth.status === 'soldout' ? 'bg-red-500 text-white shadow-lg' : 'bg-red-50 text-red-500'"><i class="fa-solid fa-ban text-xl"></i><span class="text-xs font-bold">售罄</span></button>
                        <button @click.stop="updateStatus('visited')" class="flex flex-col items-center gap-1 py-2.5 rounded-2xl active:scale-95 transition duration-200" :class="activeBooth.status === 'visited' ? 'bg-purple-500 text-white shadow-lg' : 'bg-purple-50 text-purple-500'"><i class="fa-solid fa-eye text-xl"></i><span class="text-xs font-bold">看过了</span></button>
                        <button @click.stop="deleteCurrentBooth" class="flex flex-col items-center gap-1 py-2.5 rounded-2xl text-gray-400 hover:bg-gray-100 active:scale-95 transition border border-gray-100"><i class="fa-solid fa-trash text-xl"></i><span class="text-xs font-bold">删除</span></button>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isEditing" class="fixed inset-0 z-50 bg-white/40 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl border border-gray-100 flex flex-col max-h-[90vh] overflow-hidden animate-[pop_0.3s_ease-out]">
                <div class="px-5 py-4 border-b border-gray-50 font-bold text-center text-lg text-gray-800">
                    {{ form.id ? '编辑摊位' : '记录新摊位' }}
                </div>
                <div class="p-5 overflow-y-auto flex-1 hide-scrollbar">
                    <div @click="$refs.coverInput.click()" class="w-full aspect-video bg-slate-50 rounded-2xl mb-4 flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-200 hover:border-cyan-primary/50 transition relative overflow-hidden group">
                        <img v-if="form.cover" :src="form.cover" class="w-full h-full object-contain">
                        <div v-else class="text-gray-400 flex flex-col items-center gap-2">
                            <div class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center"><i class="fa-solid fa-camera text-cyan-primary"></i></div>
                            <span class="text-xs font-medium">封面图</span>
                        </div>
                    </div>
                    <input type="file" ref="coverInput" class="invisible-input" accept="image/*" @change="handleCoverUpload">
                    
                    <div class="space-y-3">
                        <input v-model="form.name" type="text" placeholder="摊位号 / 名称 (例如 A-12)" class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-cyan-primary/20 outline-none text-gray-800 font-bold">
                        <textarea v-model="form.goods" placeholder="想买什么谷子？记下来..." rows="2" class="w-full px-4 py-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-cyan-primary/20 outline-none resize-none text-gray-800"></textarea>
                    </div>

                    <div class="mt-4">
                        <label class="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wider">必买指数 (Priority)</label>
                        <div class="flex justify-between items-center bg-slate-50 px-4 py-3 rounded-xl border border-gray-100">
                            <span class="text-xs font-bold text-gray-500">{{ form.rating }} 星</span>
                            <div class="flex gap-2">
                                <button v-for="n in 5" :key="n" @click="form.rating = n" class="text-2xl transition active:scale-125" :class="n <= form.rating ? 'text-star-gold' : 'text-gray-200'">
                                    <i class="fa-solid fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Map Point</label>
                            <div v-if="maps.length > 1" class="flex gap-1 overflow-x-auto max-w-[200px] hide-scrollbar">
                                <button v-for="m in maps" :key="m.id" 
                                    @click="switchEditMap(m.id)"
                                    :class="form.mapId === m.id ? 'bg-cyan-primary text-white' : 'bg-gray-100 text-gray-500'"
                                    class="text-[10px] px-2 py-1 rounded-lg whitespace-nowrap transition">
                                    {{ m.name }}
                                </button>
                            </div>
                        </div>

                        <div v-if="maps.length === 0" class="p-4 bg-red-50 text-red-400 text-xs rounded-xl text-center">
                            请先在右下角菜单中添加地图
                        </div>
                        
                        <div v-else 
                             class="w-full h-[250px] rounded-xl border border-gray-200 shadow-sm relative overflow-hidden touch-none"
                             ref="editMapContainer"
                             @touchstart="mapHandlers.start" 
                             @touchmove="mapHandlers.move" 
                             @touchend="mapHandlers.end">
                             
                            <div :style="mapStyle" class="origin-top-left">
                                <img :src="getMapImage(form.mapId)" class="block w-full h-auto pointer-events-none select-none">
                                <div v-if="form.x !== null" class="absolute w-5 h-5 bg-cyan-primary rounded-full border-[3px] border-white shadow-lg transform -translate-x-1/2 -translate-y-1/2"
                                    :style="{ left: form.x + '%', top: form.y + '%', transform: `translate(-50%, -100%) scale(${1/mapTransform.scale})` }"></div>
                            </div>
                            
                            <div class="absolute bottom-2 right-2 bg-cyan-primary/80 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md pointer-events-none shadow-sm">
                                点击打点 / 双指缩放
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 flex gap-3">
                    <button @click="isEditing = false" class="flex-1 py-3 rounded-xl text-gray-500 font-medium hover:bg-gray-200 transition">取消</button>
                    <button @click="saveForm" class="flex-1 py-3 bg-cyan-primary text-white rounded-xl font-bold shadow-lg shadow-cyan-primary/30 active:scale-95 transition">保存</button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isMapManagerOpen" class="fixed inset-0 z-50 bg-white/40 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl border border-gray-100 flex flex-col max-h-[80vh] overflow-hidden animate-[pop_0.3s_ease-out]">
                <div class="px-5 py-4 border-b border-gray-50 flex justify-between items-center">
                    <span class="font-bold text-lg text-gray-800">地图管理</span>
                    <button @click="isMapManagerOpen = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-4 overflow-y-auto flex-1 hide-scrollbar space-y-3">
                    <div v-for="(m, idx) in maps" :key="m.id" class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-gray-100">
                        <div class="w-12 h-12 bg-white rounded-lg overflow-hidden shrink-0 border border-gray-200">
                            <img :src="m.image" class="w-full h-full object-cover">
                        </div>
                        <input v-model="m.name" @change="saveMaps" class="flex-1 bg-transparent text-sm font-bold text-gray-700 outline-none" placeholder="地图名称">
                        <button @click="deleteMap(idx)" class="w-8 h-8 rounded-full bg-white text-red-400 shadow-sm flex items-center justify-center hover:bg-red-50"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                    <button @click="triggerAddMap" class="w-full py-3 rounded-xl border-2 border-dashed border-cyan-primary/30 text-cyan-primary font-bold text-sm hover:bg-cyan-50 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> 添加新地图
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <input type="file" ref="mapInput" class="invisible-input" accept="image/*" @change="handleAddMap">
    <input type="file" ref="coverInput" class="invisible-input" accept="image/*" @change="handleCoverUpload">
    <input type="file" ref="importInput" class="invisible-input" accept=".json" @change="handleImport">

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

    const DB_NAME = 'ComicConDB';
    const DB_VERSION = 2;
    
    // 地图原图
    const readFileOriginal = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    };

    // 封面压缩
    const compressImage = (file, maxSize = 800, quality = 0.6) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > h && w > maxSize) { h *= maxSize/w; w = maxSize; }
                    else if (h > maxSize) { w *= maxSize/h; h = maxSize; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    };

    const dbUtils = {
        db: null,
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('booths')) db.createObjectStore('booths', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                request.onerror = (e) => reject(e);
            });
        },
        async getAllBooths() {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readonly');
                const req = tx.objectStore('booths').getAll();
                req.onsuccess = () => resolve(req.result || []);
            });
        },
        async saveBooth(booth) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').put(JSON.parse(JSON.stringify(booth)));
                tx.oncomplete = () => resolve();
            });
        },
        async deleteBooth(id) {
            return new Promise(resolve => {
                const tx = this.db.transaction('booths', 'readwrite');
                tx.objectStore('booths').delete(id);
                tx.oncomplete = () => resolve();
            });
        },
        async getSetting(key) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readonly');
                const req = tx.objectStore('settings').get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
            });
        },
        async saveSetting(key, value) {
            return new Promise(resolve => {
                const tx = this.db.transaction('settings', 'readwrite');
                tx.objectStore('settings').put({ key, value });
                tx.oncomplete = () => resolve();
            });
        }
    };

    createApp({
        setup() {
            const booths = ref([]);
            const maps = ref([]); 
            const activeBooth = ref(null);
            const isEditing = ref(false);
            const isMenuOpen = ref(false);
            const isMapManagerOpen = ref(false);
            const currentFilter = ref('all');
            
            // --- 3.0 新增状态 ---
            const searchQuery = ref('');
            const sortBy = ref('time_desc'); // time_desc, rating_desc, name_asc
            
            const placeholderImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f1f5f9'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' fill='%23cbd5e1' text-anchor='middle' dy='.3em'%3ENO IMG%3C/text%3E%3C/svg%3E";
            
            // form 新增 rating
            const form = reactive({ id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending', mapId: null, rating: 3 });
            
            const filtersList = ['all', 'pending', 'bought', 'soldout'];
            const filters = [
                { key: 'all', label: '全部' }, 
                { key: 'pending', label: '待逛' }, 
                { key: 'bought', label: '已买' }, 
                { key: 'soldout', label: '售罄' }
            ];
            
            const importInput = ref(null);
            const mapInput = ref(null);
            const coverInput = ref(null);
            const modalContentRef = ref(null);
            const viewMapContainer = ref(null);
            const editMapContainer = ref(null);
            
            const touchStartY = ref(0);
            let listStartX = 0, listStartY = 0;
            const dragOffset = ref(0);
            const isDragging = ref(false);

            const mapTransform = reactive({ x: 0, y: 0, scale: 1 });
            const mapStyle = computed(() => ({ transform: `translate(${mapTransform.x}px, ${mapTransform.y}px) scale(${mapTransform.scale})` }));
            
            const resetMap = () => Object.assign(mapTransform, { x: 0, y: 0, scale: 1 });
            watch([isEditing, activeBooth], () => resetMap());

            // --- 排序逻辑计算属性 ---
            const sortLabel = computed(() => {
                if (sortBy.value === 'time_desc') return '时间';
                if (sortBy.value === 'rating_desc') return '热度';
                if (sortBy.value === 'name_asc') return '名称';
                return '排序';
            });
            
            const sortIcon = computed(() => {
                if (sortBy.value === 'time_desc') return 'fa-clock';
                if (sortBy.value === 'rating_desc') return 'fa-fire';
                if (sortBy.value === 'name_asc') return 'fa-arrow-down-a-z';
                return 'fa-sort';
            });

            // --- 核心过滤与排序 ---
            const filteredBooths = computed(() => {
                let list = booths.value;
                
                // 1. Tab 过滤
                if (currentFilter.value !== 'all') {
                    list = list.filter(b => b.status === currentFilter.value);
                }
                
                // 2. 搜索过滤 (名称 或 商品)
                if (searchQuery.value.trim()) {
                    const q = searchQuery.value.toLowerCase();
                    list = list.filter(b => (b.name && b.name.toLowerCase().includes(q)) || (b.goods && b.goods.toLowerCase().includes(q)));
                }
                
                // 3. 排序
                // 创建副本避免修改原数组
                return list.slice().sort((a, b) => {
                    if (sortBy.value === 'rating_desc') {
                        // 评分高到低，同分按时间
                        return (b.rating || 0) - (a.rating || 0) || (b.id - a.id);
                    } else if (sortBy.value === 'name_asc') {
                        // 拼音 A-Z
                        return (a.name || '').localeCompare(b.name || '', 'zh-CN');
                    } else {
                        // 默认：时间倒序 (ID大到小)
                        return b.id - a.id;
                    }
                });
            });

            const cycleSort = () => {
                if (sortBy.value === 'time_desc') sortBy.value = 'rating_desc';
                else if (sortBy.value === 'rating_desc') sortBy.value = 'name_asc';
                else sortBy.value = 'time_desc';
            };

            const mapVars = { startDist: 0, startScale: 1, startX: 0, startY: 0, lastX: 0, lastY: 0, isPinching: false, startTime: 0 };
            const mapHandlers = {
                start: (e) => {
                    if (e.touches.length === 2) {
                        mapVars.isPinching = true;
                        mapVars.startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        mapVars.startScale = mapTransform.scale;
                    } else {
                        mapVars.isPinching = false;
                        mapVars.startX = e.touches[0].clientX;
                        mapVars.startY = e.touches[0].clientY;
                        mapVars.lastX = mapTransform.x;
                        mapVars.lastY = mapTransform.y;
                        mapVars.startTime = Date.now();
                    }
                },
                move: (e) => {
                    if (e.touches.length === 2 && mapVars.isPinching) {
                        e.preventDefault();
                        const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        const newScale = mapVars.startScale * (dist / mapVars.startDist);
                        mapTransform.scale = Math.min(Math.max(newScale, 0.5), 5);
                    } else if (e.touches.length === 1 && !mapVars.isPinching) {
                        e.preventDefault();
                        const dx = e.touches[0].clientX - mapVars.startX;
                        const dy = e.touches[0].clientY - mapVars.startY;
                        mapTransform.x = mapVars.lastX + dx;
                        mapTransform.y = mapVars.lastY + dy;
                    }
                },
                end: (e) => {
                    if (isEditing.value && !mapVars.isPinching) {
                        const duration = Date.now() - mapVars.startTime;
                        const dist = Math.hypot(mapTransform.x - mapVars.lastX, mapTransform.y - mapVars.lastY);
                        if (duration < 300 && dist < 5) {
                            handleMapTap(e);
                        }
                    }
                }
            };

            const handleMapTap = (e) => {
                const container = editMapContainer.value;
                if (!container) return;
                const rect = container.getBoundingClientRect();
                const touch = e.changedTouches[0];
                const clickX = touch.clientX - rect.left;
                const clickY = touch.clientY - rect.top;
                const rawX = (clickX - mapTransform.x) / mapTransform.scale;
                const rawY = (clickY - mapTransform.y) / mapTransform.scale;
                form.x = (rawX / rect.width) * 100;
                form.y = (rawY / rect.height) * 100;
            };

            onMounted(async () => {
                await dbUtils.init();
                booths.value = await dbUtils.getAllBooths();
                const savedMaps = await dbUtils.getSetting('maps');
                if (savedMaps && Array.isArray(savedMaps)) {
                    maps.value = savedMaps;
                } else {
                    const oldMap = await dbUtils.getSetting('mapImage');
                    if (oldMap) {
                        const newMap = { id: Date.now(), name: '主展馆', image: oldMap };
                        maps.value = [newMap];
                        await dbUtils.saveSetting('maps', maps.value);
                    }
                }
            });

            const handleListTouchStart = (e) => {
                listStartX = e.touches[0].clientX;
                listStartY = e.touches[0].clientY;
            };
            const handleListTouchEnd = (e) => {
                const dx = e.changedTouches[0].clientX - listStartX;
                const dy = e.changedTouches[0].clientY - listStartY;
                if (Math.abs(dx) > Math.abs(dy) * 2 && Math.abs(dx) > 70) {
                    const currentIndex = filtersList.indexOf(currentFilter.value);
                    if (dx > 0 && currentIndex > 0) currentFilter.value = filtersList[currentIndex - 1]; 
                    else if (dx < 0 && currentIndex < filtersList.length - 1) currentFilter.value = filtersList[currentIndex + 1]; 
                }
            };

            const handleModalTouchStart = (e) => {
                if (modalContentRef.value && modalContentRef.value.scrollTop > 0) return;
                isDragging.value = true;
                touchStartY.value = e.touches[0].clientY;
            };
            const handleModalTouchMove = (e) => {
                if (!isDragging.value) return;
                const currentY = e.touches[0].clientY;
                const delta = currentY - touchStartY.value;
                if (delta > 0) {
                    dragOffset.value = delta;
                    if(e.cancelable) e.preventDefault();
                }
            };
            const handleModalTouchEnd = (e) => {
                isDragging.value = false;
                if (dragOffset.value > 120) closeDetail();
                else dragOffset.value = 0;
            };

            const openMapManager = () => isMapManagerOpen.value = true;
            const triggerAddMap = () => { if(mapInput.value) mapInput.value.click(); };
            
            const handleAddMap = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await readFileOriginal(file);
                const newMap = { id: Date.now(), name: `场馆 ${maps.value.length + 1}`, image: base64 };
                maps.value.push(newMap);
                await dbUtils.saveSetting('maps', JSON.parse(JSON.stringify(maps.value)));
                e.target.value = ''; 
            };

            const saveMaps = async () => await dbUtils.saveSetting('maps', JSON.parse(JSON.stringify(maps.value)));
            
            const deleteMap = async (idx) => {
                if(!confirm('确定删除这张地图吗？')) return;
                maps.value.splice(idx, 1);
                await saveMaps();
            };

            const getMapImage = (id) => {
                const m = maps.value.find(m => m.id === id);
                return m ? m.image : (maps.value.length > 0 ? maps.value[0].image : null);
            };
            const getMapName = (id) => {
                const m = maps.value.find(m => m.id === id);
                return m ? m.name : '';
            };
            const switchEditMap = (id) => form.mapId = id;

            const handleCoverUpload = async (e) => {
                const file = e.target.files[0];
                if (file) form.cover = await compressImage(file, 800, 0.6);
            };

            const openAddModal = () => {
                const defaultMapId = maps.value.length > 0 ? maps.value[0].id : null;
                // 默认 3 星
                Object.assign(form, { id: null, name: '', goods: '', cover: null, x: null, y: null, status: 'pending', mapId: defaultMapId, rating: 3 });
                isEditing.value = true;
            };

            const editBooth = (booth) => {
                Object.assign(form, JSON.parse(JSON.stringify(booth)));
                if (!form.mapId && maps.value.length > 0) form.mapId = maps.value[0].id;
                // 兼容旧数据
                if (form.rating === undefined) form.rating = 3;
                isEditing.value = true; activeBooth.value = null;
            };

            const setMapPoint = () => {}; 

            const saveForm = async () => {
                if (!form.name) return alert('请填写摊位名称');
                const newBooth = { ...form, id: form.id || Date.now() };
                if (!newBooth.mapId && maps.value.length > 0) newBooth.mapId = maps.value[0].id;
                const index = booths.value.findIndex(b => b.id === newBooth.id);
                if (index > -1) booths.value[index] = newBooth; else booths.value.unshift(newBooth);
                await dbUtils.saveBooth(newBooth);
                isEditing.value = false;
            };

            const viewBooth = (b) => { activeBooth.value = b; dragOffset.value = 0; };
            const closeDetail = () => { activeBooth.value = null; dragOffset.value = 0; };
            
            const updateStatus = async (status) => {
                if (!activeBooth.value) return;
                activeBooth.value.status = status;
                const index = booths.value.findIndex(b => b.id === activeBooth.value.id);
                if (index > -1) booths.value[index].status = status;
                await dbUtils.saveBooth(activeBooth.value);
                closeDetail();
            };
            
            const deleteCurrentBooth = async () => {
                if (!confirm('确定删除?')) return;
                await dbUtils.deleteBooth(activeBooth.value.id);
                booths.value = booths.value.filter(b => b.id !== activeBooth.value.id);
                closeDetail();
            };

            const exportData = async () => {
                const data = { version: 3.0, maps: maps.value, list: booths.value };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = `漫展数据_${new Date().toISOString().slice(5,10)}.json`;
                a.click(); URL.revokeObjectURL(url);
            };

            const triggerImport = () => importInput.value.click();
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!confirm(`确定导入？\n含 ${data.list ? data.list.length : 0} 个摊位。`)) return;
                        if (data.version < 2.0 && data.map) {
                            const legacyMap = { id: Date.now(), name: '导入地图', image: data.map };
                            maps.value = [legacyMap];
                            await dbUtils.saveSetting('maps', maps.value);
                        } else if (data.maps) {
                            maps.value = data.maps;
                            await dbUtils.saveSetting('maps', data.maps);
                        }
                        if (data.list) {
                            for (const item of data.list) await dbUtils.saveBooth(item);
                            booths.value = await dbUtils.getAllBooths();
                        }
                        alert("导入成功！");
                    } catch (err) { alert("文件错误"); }
                };
                reader.readAsText(file); e.target.value = '';
            };

            return {
                booths, maps, activeBooth, isEditing, isMenuOpen, isMapManagerOpen, form, currentFilter, filters, filteredBooths, placeholderImg, 
                mapInput, coverInput, importInput, modalContentRef, dragOffset, isDragging, editMapContainer, viewMapContainer,
                mapStyle, mapTransform, mapHandlers, searchQuery, sortBy, sortLabel, sortIcon, cycleSort,
                handleListTouchStart, handleListTouchEnd, handleModalTouchStart, handleModalTouchMove, handleModalTouchEnd,
                openMapManager, triggerAddMap, handleAddMap, saveMaps, deleteMap, getMapImage, getMapName, switchEditMap,
                handleCoverUpload, openAddModal, editBooth, setMapPoint, saveForm,
                viewBooth, closeDetail, updateStatus, deleteCurrentBooth, exportData, triggerImport, handleImport
            };
        }
    }).mount('#app');
</script>
</body>
</html>
